---
title: kube-proxy与iptables
date: 2023-02-20 16:07:59

category: 
  - 云原生
  - kubernetes
tag: 
  - kubernetes
---

我们知道 kube-proxy 是 Kubernetes 中一个运行在每个节点上的守护进程，它基本上反映了集群中定义的服务已经对后端 Pod 负载均衡的规则管理。

假设我们有几个 API 微服务的 Pods 运行在我们的集群中，这些 Pods 的副本通过一个 Service 服务暴露，当一个请求到达 Service 的虚拟 IP 时，如何将请求转发到其中一个底层 Pod？其实就是通过 kube-proxy 创建的规则。

<!-- more -->

[[toc]]

## iptables 和 IPvs

kube-proxy 可以在三种不同的模式下运行。

- iptables
- IPvs
- userspace(不再推荐)

虽然 iptables 模式对于许多集群和工作负载来说完全没有问题，但当服务数量很多时（超过 1,000 个），ipvs 就会很有优势了，由于 iptables 规则是按顺序读取的，如果集群中存在许多服务，那么它的使用会影响路由性能。

## 创建示例

```bash
# 创建一个基于 ghost 镜像的 Deployment（ghost 是一个免费开源的博客平台）
kubectl create deploy ghost --image=ghost --replicas=2
# 使用 NodePort 类型的 Service 来暴露 Pods。
kubectl expose deploy/ghost --port 80 --target-port 2368 --type NodePort
# Service 的相关信息
kubectl describe svc ghost
# 我们也可以使用标准的 kubectl get 命令来查询 Endpoints 信息。
kubectl get endpoints
```

## iptables 规则

每次创建/删除 Service 或修改 Endpoints 时（例如，如果由于相关应用的 scale 而导致底层 Pod 数量发生变化），kube-proxy 都会负责更新集群每个节点上的 iptables 规则。

```bash
# KUBE-NODEPORTS 链就是来处理 NodePort 类型的 Service 上的数据包
iptables -L KUBE-NODEPORTS -t nat

iptables -L KUBE-MARK-MASQ -t nat

```

> 原文地址
>
> https://mp.weixin.qq.com/s/okUrbq4lObQyO_qayRs2HA
