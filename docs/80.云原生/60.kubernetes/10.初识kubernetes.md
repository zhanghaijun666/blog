---
title: 初识kubernetes
date: 2023-02-20 16:07:59

category: 
  - 云原生
  - kubernetes
tag: 
  - Kubernetes
---

<!-- more -->

[[toc]]

## 认识容器化技术

- LXC 容器技术<br/>
  lxc --- linux containers, 集成到 linux 内核中容器化技术； lxc 没有一套详细的可操作的 api; 因此 dokcer 对 lxc 做了一个封装，开发出一套完善接口，且 docker 发布之初走开源路线，一经发布，docker 非常火；
- Docker<br/>
  Docker 原理： 依赖于镜像，容器之间隔离使用 cgroup + namespace 实现隔离的；<br/>
  与 Docker 具有同样目标功能的另外一种容器技术就是 CoreOS 公司开发的 Rocket. Rocket 基于 App Container 规范并使其成为一项更为开放的标准。
- Docker 原理<br/>
  容器是一种轻量级的虚拟化技术，因为它跟虚拟机比起来，它少了一层 [`hypervisor`](https://baike.baidu.com/item/hypervisor/3353492?fr=aladdin) 层。<br/>
  对于容器来说，最重要的是怎么保证这个进程所用到的资源是被隔离和被限制住的，在 Linux 内核上面是由 `cgroup` 和 `namespace` 这两个技术来保证的

## 容器编排技术

- 应用部署变迁<br/>
  物理机模式(操作系统) ==> 虚拟化模式(cloud os(openstack)) ==>云端模式(kubernetes)
- 容器管理<br/>
  怎么横向扩展 / 容器宕机怎么恢复 / 更新容器后不影响业务 / 如何监控容 / 如何调度新创建的容器 / 数据安全问题
- Docker-compose<br/>
  Docker-compose 是一个容器管理技术；可以实现容器批量创建，删除，更新；但是它不能实现容器精细化控制（自愈，弹性扩容，服务治理……）,且 Docker-compose 仅仅是单机版的容器编排技术，不能实现跨服务器调度；<br/>
  目前三大主流的容器平台 Swarm, Mesos 和 Kubernetes 具有不同的容器调度系统；
- Swarm <br/>
  Swarm 的特点是直接调度 Docker 容器，并且提供和标准 Docker API 一致的 API。<br/>
  每台服务器上都装有 Docker 并且开启了基于 HTTP 的 DockerAPI。这个集群中有一个 SwarmManager 的管理者，用来管理集群中的容器资源。管理者的管理对象不是服务器层面而是集群层面的，也就是说通过 Manager，我们只能笼统地向集群发出指令而不能具体到某台具体的服务器上要干什么（这也是 Swarm 的根本所在）。至于具体的管理实现方式，Manager 向外暴露了一个 HTTP 接口，外部用户通过这个 HTTP 接口来实现对集群的管理。
- Mesos <br/>
  Mesos 针对不同的运行框架采用相对独立的调度系统，其框架提供了 Docker 容器的原生支持。 Mesos 并不负责调度而是负责委派授权，毕竟很多框架都已经实现了复杂的调度。
- Kubernetes <br/>
  Kubernetes 则采用了 Pod 和 Label 这样的概念把容器组合成一个个的互相存在依赖关系的逻辑单元。相关容器被组合成 Pod 后被共同部署和调度，形成服务（Service）。这个是 Kubernetes 和 Swarm，Mesos 的主要区别。 <br/>
  Kubernetes（k8s）是自动化容器操作的开源平台，这些操作包括部署，调度和节点集群间扩展。如果你曾经用过 Docker 容器技术部署容器，那么可以将 Docker 看成 Kubernetes 内部使用的低级别组件。Kubernetes 不仅仅支持 Docker，还支持 Rocket，这是另一种容器技术。<br/>
  使用 Kubernetes 可以：  
   - 自动化容器的部署和复制 - 随时扩展或收缩容器规模 - 将容器组织成组，并且提供容器间的负载均衡 - 很容易地升级应用程序容器的新版本 - 提供容器弹性，如果容器失效就替换它，等等...

## Kubernetes(K8s)

- [kubernetes 官网](https://kubernetes.io/)
- borg 系统<br/>
  Google 的 Borg 系统运行几十万个以上的任务，来自几千个不同的应用，跨多个集群，每个集群（cell）有上万个机器。它通过管理控制、高效的任务包装、超售、和进程级别性能隔离实现了高利用率。它支持高可用性应用程序与运行时功能，最大限度地减少故障恢复时间，减少相关故障概率的调度策略。
- k8s 基本介绍<br/>
  就在 Docker 容器技术被炒得热火朝天之时，大家发现，如果想要将 Docker 应用于具体的业务实现，是存在困难的——编排、管理和调度等各个方面，都不容易。于是，人们迫切需要一套管理系统，对 Docker 及容器进行更高级更灵活的管理。就在这个时候，Kubernetes 出现了。 <br/>
  `K8s`，就是基于容器的集群管理平台，它的全称，是`kubernetes`
- k8s 主要功能<br/>
  Kubernetes 是 docker 容器用来编排和管理的工具，它是基于 Docker 构建一个容器的调度服务，提供资源调度、均衡容灾、服务注册、动态扩缩容等功能套件。<br/>
  Kubernetes 提供应用部署、维护、 扩展机制等功能，利用 Kubernetes 能方便地管理跨机器运行容器化的应用，其主要功能如下： - 自动化容器的部署和复制 - 随时扩展或收缩容器规模 - 将容器组织成组，并且提供容器间的负载均衡 - 很容易地升级应用程序容器的新版本 - 提供容器弹性，如果容器失效就替换； - 提供认证和授权: 支持属性访问控制（ABAC）、角色访问控制（RBAC）认证授权策略。
- k8s 集群<br/>
  - Master 节点（主节点）<br/>
    Master 节点包括 API Server、Scheduler、Controller manager、etcd。API Server 是整个系统的对外接口，供客户端和其它组件调用，相当于“营业厅”。Scheduler 负责对集群内部的资源进行调度，相当于“调度室”。Controller manager 负责管理控制器，相当于“大总管”。
  - node 节点（计算节点）<br/>
    Node 节点包括 Docker、kubelet、kube-proxy、Fluentd、kube-dns（可选）、**Pod**

## 云原生技术

云原生技术—以 k8s 为核心的一套云原生架构体系，叫做云原生技术（软件架构体系），架构师在架构时候遵循 kubernetes 云原生架构设计模式，把这种架构模式叫做云原生架构；<br/>
应用角度： 让所有的软件服务都必须运行在容器中，然后使用容器编排技术进行管理，这样的架构就叫做云原生架构；<br/>
云原生特点：<br/>
1）容器化： 所有应用程序都必须运行在容器中 <br/>
2）微服务： 项目最好是采用微服务架构，适合运行在容器中（云端），实现云原生架构模式 <br/>
3）DevOps: 开发+运营的结合体，DevOps 是一种敏捷开发的思想，一种组织形式，实现开发的流水线生产模式；<br/>
4）CI/CD: 可持续部署，可持续集成 <br/>

## k8s 资源指令

- 基础操作

```bash
# 创建且运行一个pod
# deployment、rs、pod被自动创建
kubectl run my-nginx --image=nginx --port=80
# 增加创建副本数量
kubectl scale deployment/my-nginx --replicas = 3
# 添加service
# kubectl expose将RC、Service、Deployment或Pod作为新的Kubernetes Service公开。
kubectl expose deployment/my-nginx --port=30000 --target-port=80
# 编辑service配置文件
kubectl edit svc/my-nginx

# 其他的基础指令
# 查看集群中有几个Node
kubectl get nodes
# 查看pod
kubectl  get pods
# 查看服务详情信息
kubectl describe pod my-nginx-379829228-cwlbb
# 查看已部署
kubectl  get deployments
# 删除pod
kubectl delete pod my-nginx-379829228-cwlbb
# 删除部署的my-nginx服务。彻底删除pod
kubectl delete deployment my-nginx
# 删除service服务
kubectl delete service my-nginx
```

- 命令手册<br/>
  kubenetes 命令手册，详情请查询下表：

| 类型               | 命令                                                                   | 描述                               |
| ------------------ | ---------------------------------------------------------------------- | ---------------------------------- |
| 基础命令           | create                                                                 | 通过文件名或标准输入创建资源       |
| ecpose             | 将一个资源公开为一个新的 Service                                       |                                    |
| run                | 在集群中运行一个特定的镜像                                             |                                    |
| set                | 在对象上设置特定的功能                                                 |                                    |
| get                | 显示一个或多个资源                                                     |                                    |
| explain            | 文档参考资料                                                           |                                    |
| edit               | 使用默认的编辑器编辑一个资源                                           |                                    |
| delete             | 通过文件名，标准输入，资源名称或者标签选择器来删除资源                 |                                    |
| 部署命令           | rollout                                                                | 管理资源的发布                     |
| rolling-update     | 对给定的复制控制器滚动更新                                             |                                    |
| scale              | 扩容会缩容 Pod 数量，Deployment，ReplicaSet，RC 或 Job                 |                                    |
| autoscale          | 创建一个自动选择扩容或缩容并设置 Pod 数量                              |                                    |
| 集群管理命令       | certificate                                                            | 修改证书资源                       |
| cluster-info       | 显示集群信息                                                           |                                    |
| top                | 显示资源（CPU/Memory/Storage)使用，需要 Heapster 运行                  |                                    |
| cordon             | 标记节点不可调                                                         |                                    |
| uncordon           | 标记节点可调度                                                         |                                    |
| drain              | 驱逐节点上的应用，准备下线维护                                         |                                    |
| taint              | 修改节点 taint 标记                                                    |                                    |
| 故障诊断和调试命令 | describe                                                               | 显示特定资源或资源组的详细信息     |
| logs               | 在一个 Pod 中打印一个容器日志，如果 Pod 只有一个容器，容器名称是可选的 |                                    |
| attach             | 附加到一个运行的容器                                                   |                                    |
| exec               | 执行命令到容器                                                         |                                    |
| port-forward       | 转发一个或多个本地端口到一个 pod                                       |                                    |
| proxy              | 运行一个 proxy 到 Kubernetes API server                                |                                    |
| cp                 | 拷贝文件或者目录到容器中                                               |                                    |
| auth               | 检查授权                                                               |                                    |
| 高级命令           | apply                                                                  | 通过文件名或标准输入对资源应用配置 |
| patch              | 使用补丁修改，更新资源的字段                                           |                                    |
| replace            | 通过文件名或标准输入替换一个资源                                       |                                    |
| convert            | 不同的 API 版本之间转换配置文件                                        |                                    |
| 设置命令           | label                                                                  | 更新资源上的标签                   |
| annotate           | 更新资源上的注释                                                       |                                    |
| completion         | 用于实现 kubectl 工具自动补全                                          |                                    |
| 其他命令           | api-versions                                                           | 打印受支持的 API 版本              |
| config             | 修改 kubeconfig 文件（用于访问 API，比如配置认证信息）                 |                                    |
| help               | 所有命令帮助                                                           |                                    |
| plugin             | 运行一个命令插件                                                       |                                    |
| version            | 打印客户端和服务版本信息                                               |                                    |
